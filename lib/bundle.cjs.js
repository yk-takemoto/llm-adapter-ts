"use strict";var e=require("openai"),t=require("fs"),o=require("zod"),s=require("@anthropic-ai/sdk"),n=require("@google/generative-ai"),r=require("groq-sdk");class a{constructor(t={apiKey:JSON.parse(process.env.APP_SECRETS||"{}").OPENAI_API_KEY||process.env.OPENAI_API_KEY,apiModelChat:process.env.OPENAI_API_MODEL_CHAT,apiModelAudioTranscription:process.env.OPENAI_API_MODEL_AUDIO_TRANSCRIPTION,apiModelText2Speech:process.env.OPENAI_API_MODEL_TEXT2SPEECH},s=o.z.object({apiKey:o.z.string().min(1,"OPENAI_API_KEY is required"),apiModelChat:o.z.string().min(1,"OPENAI_API_MODEL_CHAT is required"),apiModelAudioTranscription:o.z.string().optional(),apiModelText2Speech:o.z.string().optional()}),n){this.llmConfig=s.parse(t),this.openaiClient=n||new e({apiKey:t.apiKey})}addAdditionalPropertiesElementToObjectType(e,t=!1){if("object"!=typeof e||null===e)return e;if("object"===e.type&&(e.additionalProperties=t,e.properties))for(const o in e.properties)e.properties[o]=this.addAdditionalPropertiesElementToObjectType(e.properties[o],t);return"array"===e.type&&e.items&&(e.items=this.addAdditionalPropertiesElementToObjectType(e.items,t)),e}convertTools(e,t){const o=t?{strict:t}:{};return e.map((e=>({type:"function",function:{name:e.name,description:e.description,...o,parameters:t?this.addAdditionalPropertiesElementToObjectType(e.inputSchema,!t):e.inputSchema}})))}convertResponseFormatJSONSchema(e){return{type:"json_schema",json_schema:{name:e.name,description:e.description,strict:!0,schema:this.addAdditionalPropertiesElementToObjectType(e.inputSchema,!1)}}}async chatCompletions(e,t,o,s){let n=[];if(s){const e=s.toolResults?.map((e=>({tool_call_id:e.id,role:"tool",content:e.content})))||[];n=s.messages.concat(e)}else e.forEach((e=>{n.push({role:"system",content:e})}));t.length>0&&n.push({role:"user",content:t.map((e=>e.image?{type:"image_url",image_url:{url:e.image.url,detail:e.image.detail||"auto"}}:e.audio?{type:"input_audio",input_audio:{data:e.audio.data,format:e.audio.format||"mp3"}}:{type:"text",text:e.text||""}))});let r={},a={};o.tools&&o.tools.length>0&&(r="function"===o.toolOption.type||"function_strict"===o.toolOption.type?{tools:this.convertTools(o.tools,"function_strict"===o.toolOption.type),tool_choice:o.toolOption.choice||"auto"}:{},a="response_format"===o.toolOption.type?{response_format:this.convertResponseFormatJSONSchema(o.tools[0])}:{});const i={model:this.llmConfig.apiModelChat,messages:n,max_tokens:o.toolOption.maxTokens||1028,temperature:o.toolOption.temperature??.7,...r,...a};let c={text:"",tools:[],messages:[]};try{console.log("[chatCompletions] start -- updatedMessages: ",JSON.stringify(n));const e=(await this.openaiClient.chat.completions.create(i)).choices[0],t=e.finish_reason;console.log(`[chatCompletions] end -- choices[0].message: ${JSON.stringify(e.message)} finishReason: ${t}`);let o=[];e.message&&(n.push(e.message),o="tool_calls"===t&&e.message.tool_calls?.map((e=>({id:e.id,name:e.function.name,arguments:JSON.parse(e.function.arguments)})))||[]),c={text:e.message?.content,tools:o,messages:n}}catch(e){throw console.log("[chatCompletions] Error: ",e),e}return console.log("[chatCompletions] response: ",c),c}async speechToText(e,o){const s={file:t.createReadStream(e),model:this.llmConfig.apiModelAudioTranscription||"whisper-1",language:o?.language||"ja"};try{return(await this.openaiClient.audio.transcriptions.create(s)).text}catch(e){throw console.log("[speechToText] Error: ",e),e}}async textToSpeech(e,t){const o={model:this.llmConfig.apiModelText2Speech||"tts-1",input:e,voice:t?.voice||"alloy",response_format:t?.responseFormat||"mp3"};try{const e=await this.openaiClient.audio.speech.create(o),t=e.headers.get("content-type"),s=await e.arrayBuffer();return{contentType:t,content:Buffer.from(s)}}catch(e){throw console.log("[textToSpeech] Error: ",e),e}}}const i={OpenAI:a,AzureOpenAI:class extends a{constructor(t={apiKey:JSON.parse(process.env.APP_SECRETS||"{}").AZURE_OPENAI_API_KEY||process.env.AZURE_OPENAI_API_KEY,apiModelChat:process.env.AZURE_OPENAI_API_DEPLOYMENT_CHAT,apiModelAudioTranscription:process.env.AZURE_OPENAI_API_DEPLOYMENT_AUDIO_TRANSCRIPTION,apiModelText2Speech:process.env.AZURE_OPENAI_API_DEPLOYMENT_TEXT2SPEECH,endpoint:process.env.AZURE_OPENAI_ENDPOINT,apiVersion:process.env.OPENAI_API_VERSION},s=o.z.object({apiKey:o.z.string().min(1,"AZURE_OPENAI_API_KEY is required"),apiModelChat:o.z.string().min(1,"AZURE_OPENAI_API_DEPLOYMENT_CHAT is required"),apiModelAudioTranscription:o.z.string().optional(),apiModelText2Speech:o.z.string().optional(),endpoint:o.z.string().min(1,"AZURE_OPENAI_ENDPOINT is required"),apiVersion:o.z.string().min(1,"OPENAI_API_VERSION is required")})){super(t,s,new e.AzureOpenAI({apiKey:t.apiKey,endpoint:t.endpoint,apiVersion:t.apiVersion}))}},Anthropic:class{constructor(e={apiKey:JSON.parse(process.env.APP_SECRETS||"{}").ANTHROPIC_API_KEY||process.env.ANTHROPIC_API_KEY,apiModelChat:process.env.ANTHROPIC_API_MODEL_CHAT},t=o.z.object({apiKey:o.z.string().min(1,"ANTHROPIC_API_KEY is required"),apiModelChat:o.z.string().min(1,"ANTHROPIC_API_MODEL_CHAT is required")})){this.llmConfig=t.parse(e),this.anthropicClient=new s({apiKey:e.apiKey})}convertTools(e){return e.map((e=>({name:e.name,description:e.description,input_schema:e.inputSchema})))}async convertImageUrlToBase64(e){try{const t=await fetch(e),o=await t.arrayBuffer(),s=Buffer.from(o),n=t.headers.get("content-type")||"image/jpeg";return{mimeType:n,base64Content:s.toString("base64")}}catch(e){throw new Error(`Failed to fetch or convert image: ${e}`)}}convertMessagesForHistory(e){return e.map((e=>({role:e.role,content:Array.isArray(e.content)?e.content.map((e=>"image"===e.type?{...e,source:{...e.source,data:"ommitted"}}:e)):e.content})))}async chatCompletions(e,t,o,s){const n=[];e.forEach((e=>{n.push({type:"text",text:e})}));let r=[];if(s){const e=s.toolResults?.map((e=>({tool_use_id:e.id,type:"tool_result",content:e.content})))||[];r=s.messages.concat({role:"user",content:e})}if(t.length>0){const e=await Promise.all(t.map((async e=>{if(e.image){const{mimeType:t,base64Content:o}=await this.convertImageUrlToBase64(e.image.url);return{type:"image",source:{type:"base64",media_type:t,data:o}}}return{type:"text",text:e.text||""}})));r.push({role:"user",content:e})}const a=o.tools&&o.tools.length>0?{tools:this.convertTools(o.tools),tool_choice:{type:o.toolOption.choice||"auto"}}:{},i={model:this.llmConfig.apiModelChat,messages:r,system:n,max_tokens:o.toolOption.maxTokens||1028,temperature:o.toolOption.temperature??.7,...a};let c={text:"",tools:[],messages:[]};try{const e=this.convertMessagesForHistory(r);console.log("[chatCompletions] start -- covertedSystemPrompt: ",JSON.stringify(n)," -- historyMessages: ",JSON.stringify(e));const t=await this.anthropicClient.messages.create(i),s=t.content,a=t.stop_reason;console.log(`[chatCompletions] end -- contents: ${JSON.stringify(s)} stopReason: ${a}`);let p=[];t&&(e.push({role:t.role,content:s}),p="tool_use"===a&&s?.filter((e=>"tool_use"===e.type)).map((e=>({id:e.id,name:e.name,arguments:JSON.parse(JSON.stringify(e.input))})))||[]),c={text:p.length>0&&"response_format"===o.toolOption.type?JSON.stringify(p[0].arguments):s[0].text||null,tools:p,messages:e}}catch(e){throw console.log("[chatCompletions] Error: ",e),e}return console.log("[chatCompletions] response: ",c),c}async speechToText(e,t){try{return"unsupported"}catch(e){throw console.log("[speechToText] Error: ",e),e}}async textToSpeech(e,o){try{const e="wav"===o?.responseFormat||"aac"===o?.responseFormat?o.responseFormat:"mp3",s=await t.promises.readFile(`audio/sorry.ja.${e}`);return{contentType:"mp3"===e?"audio/mpeg":`audio/${e}`,content:s}}catch(e){throw console.log("[textToSpeech] Error: ",e),e}}},Google:class{constructor(e={apiKey:JSON.parse(process.env.APP_SECRETS||"{}").GEMINI_API_KEY||process.env.GEMINI_API_KEY,apiModelChat:process.env.GEMINI_API_MODEL_CHAT},t=o.z.object({apiKey:o.z.string().min(1,"GEMINI_API_KEY is required"),apiModelChat:o.z.string().min(1,"GEMINI_API_MODEL_CHAT is required")})){this.llmConfig=t.parse(e),this.geminiClient=new n.GoogleGenerativeAI(e.apiKey)}cleanJsonSchema(e){if("object"!=typeof e||null===e)return e;if("object"===e.type){const t={};return Object.keys(e).forEach((o=>{"additionalProperties"!==o&&"$schema"!==o&&("properties"===o?t.properties=Object.keys(e.properties).reduce(((t,o)=>({...t,[o]:this.cleanJsonSchema(e.properties[o])})),{}):t[o]=e[o])})),t}if("array"===e.type&&e.items){const{items:t,...o}=e;return{...o,items:this.cleanJsonSchema(t)}}return e}convertTools(e){const t=e.map((e=>({name:e.name,description:e.description,parameters:this.cleanJsonSchema(e.inputSchema)})));return console.log("[convertTools] functions: ",JSON.stringify(t,null,2)),[{functionDeclarations:t}]}convertResponseFormatJSONSchema(e){return{responseMimeType:"application/json",responseSchema:this.cleanJsonSchema(e.inputSchema)}}async convertImageUrlToBase64(e){try{const t=await fetch(e),o=await t.arrayBuffer(),s=Buffer.from(o),n=t.headers.get("content-type")||"image/jpeg";return{mimeType:n,base64Content:s.toString("base64")}}catch(e){throw new Error(`Failed to fetch or convert image: ${e}`)}}convertMessagesForHistory(e){return e.map((e=>({role:e.role,parts:e.parts.map((e=>e.inlineData?.data?{...e,inlineData:{...e.inlineData,data:"ommitted"}}:e))})))}async chatCompletions(e,t,o,s){const r={role:"model",parts:[]};e.forEach((e=>{r.parts.push({text:e})}));let a=[];if(s){const e=s.toolResults?.map((e=>({text:e.content})))||[];a=s.messages.concat({role:"user",parts:e})}if(t.length>0){const e=await Promise.all(t.map((async e=>{if(e.image){const{mimeType:t,base64Content:o}=await this.convertImageUrlToBase64(e.image.url);return{inlineData:{mimeType:t,data:o}}}return{text:e.text||""}})));a.push({role:"user",parts:e})}let i={},c={};o.tools&&o.tools.length>0&&(i="function"===o.toolOption.type||"function_strict"===o.toolOption.type?{tools:this.convertTools(o.tools),toolConfig:{functionCallingConfig:{mode:String(o.toolOption.choice).toUpperCase()||n.FunctionCallingMode.AUTO}}}:{},c="response_format"===o.toolOption.type?this.convertResponseFormatJSONSchema(o.tools[0]):{});const p={safetySettings:[{category:n.HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,threshold:n.HarmBlockThreshold.BLOCK_ONLY_HIGH}],generationConfig:{maxOutputTokens:o.toolOption.maxTokens||1028,temperature:o.toolOption.temperature??.7,...c},model:this.llmConfig.apiModelChat,systemInstruction:r,...i};let l={text:"",tools:[],messages:[]};try{const e=this.convertMessagesForHistory(a);console.log("[chatCompletions] start -- historyMessages: ",JSON.stringify(e));const t=(await this.geminiClient.getGenerativeModel(p).generateContent({contents:a})).response,o=t.text(),s=t.functionCalls(),n=t.candidates&&t.candidates[0].finishReason;console.log(`[chatCompletions] end -- response.text: ${o} response.functionCalls: ${JSON.stringify(s)} finishReason: ${n}`);let r=[];if(t){const t=[];r=s&&s?.map((e=>(t.push({functionCall:e}),{id:"",name:e.name,arguments:JSON.parse(JSON.stringify(e.args))})))||[],e.push({role:"model",parts:t})}l={text:o,tools:r,messages:e}}catch(e){throw console.log("[chatCompletions] Error: ",e),e}return console.log("[chatCompletions] response: ",l),l}async speechToText(e,t){try{return"unsupported"}catch(e){throw console.log("[speechToText] Error: ",e),e}}async textToSpeech(e,o){try{const e="wav"===o?.responseFormat||"aac"===o?.responseFormat?o.responseFormat:"mp3",s=await t.promises.readFile(`audio/sorry.ja.${e}`);return{contentType:"mp3"===e?"audio/mpeg":`audio/${e}`,content:s}}catch(e){throw console.log("[textToSpeech] Error: ",e),e}}},Groq:class{constructor(e={apiKey:JSON.parse(process.env.APP_SECRETS||"{}").GROQ_API_KEY||process.env.GROQ_API_KEY,apiModelChat:process.env.GROQ_API_MODEL_CHAT},t=o.z.object({apiKey:o.z.string().min(1,"GROQ_API_KEY is required"),apiModelChat:o.z.string().min(1,"GROQ_API_MODEL_CHAT is required")})){this.llmConfig=t.parse(e),this.groqClient=new r.Groq({apiKey:e.apiKey})}convertTools(e){return e.map((e=>({type:"function",function:{name:e.name,description:e.description,parameters:e.inputSchema}})))}async chatCompletions(e,t,o,s){let n=[];if(s){const e=s.toolResults?.map((e=>({tool_call_id:e.id,role:"tool",content:e.content})))||[];n=s.messages.concat(e)}else{t.some((e=>e.image))?n.push({role:"user",content:e.map((e=>({type:"text",text:e})))}):e.forEach((e=>{n.push({role:"system",content:e})}))}t.length>0&&n.push({role:"user",content:t.map((e=>e.image?{type:"image_url",image_url:{url:e.image.url,detail:e.image.detail||"auto"}}:{type:"text",text:e.text||""}))});let r={},a={};o.tools&&o.tools.length>0&&(r="function"===o.toolOption.type||"function_strict"===o.toolOption.type?{tools:this.convertTools(o.tools),tool_choice:o.toolOption.choice||"auto"}:{},a="response_format"===o.toolOption.type?{response_format:{type:"json_object"}}:{});const i={model:this.llmConfig.apiModelChat,messages:n,max_tokens:o.toolOption.maxTokens||1028,temperature:o.toolOption.temperature??.7,...r,...a};let c={text:"",tools:[],messages:[]};try{console.log("[chatCompletions] start -- updatedMessages: ",JSON.stringify(n));const e=(await this.groqClient.chat.completions.create(i)).choices[0],t=e.finish_reason;console.log(`[chatCompletions] end -- choices[0].message: ${JSON.stringify(e.message)} finishReason: ${t}`);let o=[];e.message&&(n.push(e.message),o="tool_calls"===t&&e.message.tool_calls?.map((e=>({id:e.id,name:e.function.name,arguments:JSON.parse(e.function.arguments)})))||[]),c={text:e.message?.content,tools:o,messages:n}}catch(e){throw console.log("[chatCompletions] Error: ",e),e}return console.log("[chatCompletions] response: ",c),c}async speechToText(e,t){try{return"unsupported"}catch(e){throw console.log("[speechToText] Error: ",e),e}}async textToSpeech(e,o){try{const e="wav"===o?.responseFormat||"aac"===o?.responseFormat?o.responseFormat:"mp3",s=await t.promises.readFile(`audio/sorry.ja.${e}`);return{contentType:"mp3"===e?"audio/mpeg":`audio/${e}`,content:s}}catch(e){throw console.log("[textToSpeech] Error: ",e),e}}}},c=o.z.object({text:o.z.string().nullable(),tools:o.z.array(o.z.object({id:o.z.string(),name:o.z.string(),arguments:o.z.record(o.z.any())})),messages:o.z.array(o.z.any())}),p=o.z.object({text:o.z.string().optional(),image:o.z.object({url:o.z.string(),detail:o.z.any().optional()}).optional(),audio:o.z.object({data:o.z.string(),format:o.z.any().optional()}).optional()}),l=o.z.object({tools:o.z.array(o.z.any()).optional(),toolOption:o.z.object({choice:o.z.any().optional(),maxTokens:o.z.number().optional(),temperature:o.z.number().optional(),type:o.z.enum(["function","function_strict","response_format"]).optional()})}),m=o.z.object({contentType:o.z.string(),content:o.z.instanceof(Buffer)}),h=o.z.object({name:o.z.string(),description:o.z.string(),inputSchema:o.z.object({type:o.z.string(),properties:o.z.record(o.z.any()),required:o.z.array(o.z.string())})});var u=Object.freeze({__proto__:null,llmChatCompletionsContentSchema:p,llmChatCompletionsOptionsSchema:l,llmChatCompletionsResponseSchema:c,llmTextToSpeechResponseSchema:m,mcpToolSchema:h});exports.LlmAdapterSchemas=u,exports.llmAdapterBuilder=e=>new(0,i[e]);
//# sourceMappingURL=bundle.cjs.js.map
